@startuml
title HappyHaushalt â€” UML Class Diagram (Domain + Repos + Offline)

' ---------- Styling (optional, keeps it readable) ----------
hide circle
skinparam classAttributeIconSize 0
skinparam packageStyle rectangle

' ---------- Packages ----------
package "core/types" {
  class Household {
    +id: string
    +name: string
    +joinCode: string
  }

  class Member {
    +id: string
    +householdId: string
    +userId: string
    +displayName: string
    +avatarId: string
  }

  class ChoreTemplate {
    +id: string
    +householdId: string
    +name: string
    +area: Area
    +frequency: Frequency
    +rotationCursor: number
    +archived: boolean
  }

  class TaskInstance {
    +id: string
    +householdId: string
    +choreTemplateId: string
    +dueDate: string
    +assignedMemberId: string
    +status: TaskStatus
    +completedAt: string?
  }

  class OutboxOp {
    +id: string
    +type: OutboxOpType
    +payload: any
    +status: OutboxStatus
    +error: string?
    +createdAt: string
  }

  enum Area {
    kitchen
    bathroom
    living_room
    general
  }

  enum TaskStatus {
    open
    done
  }

  enum OutboxStatus {
    pending
    syncing
    failed
    done
  }

  enum OutboxOpType {
    create_household
    join_household
    upsert_member_profile
    create_chore_template
    update_chore_template
    archive_chore_template
    complete_task
    create_next_task
  }

  class Frequency {
    +kind: "weekly" | "every_x_days"
    +everyXDays: number?
  }
}

package "core/repos (interfaces)" {
  interface AuthRepo {
    +signInWithGoogle(): Promise<void>
    +signOut(): Promise<void>
    +getSession(): Promise<Session?>
  }

  interface HouseholdRepo {
    +createHousehold(name: string): Promise<Household>
    +joinByCode(code: string): Promise<Household>
    +getCurrentHousehold(): Promise<Household?>
    +getJoinCode(): Promise<string?>
    +listMembers(): Promise<Member[]>
  }

  interface MemberRepo {
    +ensureMemberExists(): Promise<Member>
    +getCurrentMember(): Promise<Member?>
    +updateProfile(displayName: string, avatarId: string): Promise<Member>
  }

  interface ChoreRepo {
    +listTemplates(): Promise<ChoreTemplate[]>
    +getTemplate(id: string): Promise<ChoreTemplate?>
    +createTemplate(dto: any): Promise<ChoreTemplate>
    +updateTemplate(id: string, dto: any): Promise<ChoreTemplate>
    +archiveTemplate(id: string): Promise<void>
  }

  interface TaskRepo {
    +listTasks(filter?: any): Promise<TaskInstance[]>
    +completeTask(taskId: string): Promise<void>
  }
}

package "core/offline" {
  class DexieDB {
    +households
    +members
    +choreTemplates
    +tasks
    +outbox
  }

  class OfflineEngine {
    +enqueue(op: OutboxOp): Promise<void>
    +syncNow(): Promise<void>
    +retryFailed(): Promise<void>
  }
}

package "core/repos (implementations)" {
  class LocalDexieRepo
  class SupabaseRemoteAdapter
}

' ---------- Relationships (domain) ----------
Household "1" o-- "*" Member : has
Household "1" o-- "*" ChoreTemplate : defines
Household "1" o-- "*" TaskInstance : schedules
ChoreTemplate "1" o-- "*" TaskInstance : generates
Member "1" o-- "*" TaskInstance : assigned

' ---------- Relationships (repos + storage) ----------
LocalDexieRepo ..|> HouseholdRepo
LocalDexieRepo ..|> MemberRepo
LocalDexieRepo ..|> ChoreRepo
LocalDexieRepo ..|> TaskRepo

SupabaseRemoteAdapter ..|> HouseholdRepo
SupabaseRemoteAdapter ..|> MemberRepo
SupabaseRemoteAdapter ..|> ChoreRepo
SupabaseRemoteAdapter ..|> TaskRepo
SupabaseRemoteAdapter ..|> AuthRepo

LocalDexieRepo --> DexieDB : reads/writes
OfflineEngine --> DexieDB : reads/writes outbox
OfflineEngine --> SupabaseRemoteAdapter : sync ops

' ---------- UI rule (note) ----------
note "Rule: UI/Features call only Repo interfaces.\nUI never calls DexieDB or Supabase directly." as N1
N1 .. HouseholdRepo
N1 .. MemberRepo
N1 .. ChoreRepo
N1 .. TaskRepo
N1 .. AuthRepo

@enduml
